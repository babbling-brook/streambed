"object"!=typeof BabblingBrook.Client.Page.Post&&(BabblingBrook.Client.Page.Post={}),BabblingBrook.Client.Page.Post.PostWithTree=function(){"use strict";var e,r,o,t,n,i,a=[],s=jQuery.Deferred(),l=function(e){e.name=BabblingBrook.Library.normaliseResourceName(e.name);var r=BabblingBrook.Library.makeRhythmUrl(e,"json");i!==r&&(jQuery("#loading_children").removeClass("hide"),jQuery("#root_post>.children").empty(),c(e),i=r)},d=function(e,r){if("undefined"==typeof e.sort||""===e.sort)return void jQuery("div>span.sort-score-intro",r).addClass("hide");var o=jQuery("div>span.sort-score-intro>span.sort-score",r);o.text(e.sort),parseInt(e.sort)<-2&&r.addClass("low-sort"),parseInt(e.sort)>1e9&&r.addClass("high-sort")},u=function(e,r,o){if("boolean"!=typeof o||o!==!1){var n=jQuery(".post[data-post-id="+r.parent_id+"]>ul.children"),i=jQuery("li.post[data-post-id="+r.post_id+"]",n);BabblingBrook.Client.Component.Post(r,i,t,">ul.children",t,d.bind(null,r),e)}},p=function(e,r,o){var t=jQuery(".post[data-post-id="+r.parent_id+"]>ul.children"),n=jQuery("li.post[data-post-id="+r.post_id+"]",t);if(0===n.length){var i=jQuery("#post_tree_dummy_post>li").clone();i.attr("data-post-id",r.post_id),e===!0?(t.prepend(i),n=jQuery(">li:first",t)):(t.append(i),n=jQuery(">li:last",t))}o===!1&&"deleted"===r.username?BabblingBrook.Client.Component.Value.areAnyTaken(r,u.bind(null,e,r)):u(e,r)},m=function(o){if(BabblingBrook.Client.Component.StreamSideBar.onSorted(o.sort_request.filter.url),o.sort_request.update===!0)BabblingBrook.Client.Core.Tree.update(o.posts,e.post_id,e.domain,o.sort_request.filter.url),i===o.sort_request.filter.url&&BabblingBrook.Client.Core.Tree.displayTreeUpdate(e.post_id,e.domain,i,p.bind(null,!0));else{BabblingBrook.Client.Core.Tree.create(o.posts,e.post_id,e.domain,o.sort_request.filter.url),i===o.sort_request.filter.url&&BabblingBrook.Client.Core.Tree.displayTree(e.post_id,e.domain,i,p.bind(null,!1)),jQuery("#loading_children").addClass("hide");var t={streams:o.sort_request.streams,client_uid:o.sort_request.client_uid,post_id:o.sort_request.post_id,type:o.sort_request.type,filter:o.sort_request.filter,moderation_rings:o.sort_request.moderation_rings,refresh_frequency:o.sort_request.refresh_frequency,priority:o.sort_request.priority,success:m,error:_};BabblingBrook.Client.Core.FetchMore.register(t),BabblingBrook.Client.Component.Tutorial.readCommentsHack(r,e)}},b=function(){BabblingBrook.Client.Core.Interact.postAMessage({feature:"stream_post",url:o},"RecordFeatureUsed")},_=function(e){BabblingBrook.Client.Component.StreamError.error(e,"tree")},c=function(t){jQuery("#tree_root>li>.children").empty();var n=[];t.name=BabblingBrook.Library.normaliseResourceName(t.name);var i=BabblingBrook.Library.makeRhythmUrl(t,"json"),a={url:i,priority:t.priority,name:t.name};"undefined"==typeof r&&(r=BabblingBrook.Library.makeStreamFromUrl(o));var s=e.domain+"/"+e.post_id;BabblingBrook.Client.Core.Interact.postAMessage({sort_request:{type:"tree",client_uid:s,streams:[r],post_id:e.post_id,filter:a,moderation_rings:n,posts_to_timestamp:null}},"SortRequest",m,_)},B=function(e,o){s.done(function(){for(var t=a.length,n=0;t>n;n++)a[n](o,e,r)})},g=function(e){r=jQuery.extend({},e),"string"==typeof e.version&&(r.version=BabblingBrook.Library.makeVersionObject(e.version)),s.resolve(),BabblingBrook.Client.Component.StreamSideBar.onStreamChanged(e)},y=function(r){e=r,o=BabblingBrook.Library.makeStreamUrl({domain:e.stream_domain,username:e.stream_username,name:e.stream_name,version:e.stream_version},"json"),BabblingBrook.Client.Core.Streams.getStream(e.domain,e.stream_username,e.stream_name,e.stream_version,g);var i=jQuery("#tree_branch_template>ul").clone();jQuery("#loading_main_post").replaceWith(i);var a=jQuery(">li.post",i),s=jQuery("#post_tree_root_template>li").clone();s.attr("id","root_post"),t=jQuery("#post_tree_child_template>li").clone(),BabblingBrook.Client.Component.Post(e,a,s,">ul.children",t,B.bind(null,e)),b(),c(n[0])};return{construct:function(){var e=window.location.pathname,r=e.split("/"),o=r[2];n=BabblingBrook.Client.ClientConfig.default_sort_filters,n[0].name=BabblingBrook.Library.normaliseResourceName(n[0].name),i=BabblingBrook.Library.makeRhythmUrl(n[0],"json"),BabblingBrook.Client.Component.StreamSideBar.onFiltersLoaded(n,l),BabblingBrook.Client.Core.Interact.postAMessage({domain:o,post_id:r[3]},"GetPost",y,function(e){var r="There has been an error whilst fetching an post.";"GetPost_not_found"===e.error_code?r="This post does not exist.":"GetPost_takes_failed"===e.error_code&&(r="There was an error whilst fetching your take data for this post."),BabblingBrook.Client.Component.Messages.addMessage({type:"error",message:r,full:e.error_code}),jQuery("#loading_main_post").remove()}),BabblingBrook.Client.Core.Loaded.setPostWithTreeLoaded()},registerOnRootPostDisplayHook:function(e){if("function"!=typeof e)throw console.trace(),"Passed in onDisplayRootPostExtraCallback is not a function";a.push(e)}}}(),jQuery(function(){"use strict";BabblingBrook.Client.Core.Loaded.onUserLoaded(function(){BabblingBrook.Client.Page.Post.PostWithTree.construct()})});
//# sourceMappingURL=/js/Minified/Client/Page/Post/PostWithTree.js.map