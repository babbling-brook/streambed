"object"!=typeof BabblingBrook.Client.Page.Stream&&(BabblingBrook.Client.Page.Stream={}),BabblingBrook.Client.Page.Stream.Stream=function(){"use strict";var e,r,o,t,a,n,i,s,l,b,m="#post_stream_template>.post",d="#stream_photowall_template>.post",u=function(){e=jQuery("#stream_container"),e.empty(),n=void 0,s=void 0,t=void 0,l=void 0,i=void 0},c=function(){var e=BabblingBrook.Library.extractAction(window.location.href);if("rhythm"===e){var r=window.location.href;l={domain:BabblingBrook.Library.extractPathItem(r,8),username:BabblingBrook.Library.extractPathItem(r,9),name:BabblingBrook.Library.decodeUrlComponent(BabblingBrook.Library.extractPathItem(r,10)),version:BabblingBrook.Library.extractPathItem(r,11)+"/"+BabblingBrook.Library.extractPathItem(r,12)+"/"+BabblingBrook.Library.extractPathItem(r,13)}}},B=function(e,r){if("undefined"==typeof r.sort||""===r.sort)return void jQuery("div>span.sort-score-intro",e).addClass("hide");var o=jQuery("div>span.sort-score-intro>span.sort-score",e);o.text(r.sort),parseInt(r.sort)<-2&&e.addClass("low-sort"),parseInt(r.sort)>1e9&&e.addClass("high-sort")},g=function(e){var r=BabblingBrook.Library.makeStreamUrl(e.streams[0],"json"),o={streams:e.streams,client_uid:e.client_uid,post_id:null,type:e.type,filter:e.filter,moderation_rings:e.moderation_rings,priority:e.priority,refresh_frequency:e.refresh_frequency,block_numbers:e.block_numbers,success:y.bind(null,void 0),error:p.bind(null,r)};BabblingBrook.Client.Core.FetchMore.register(o)},f=function(){e.empty(),_()},y=function(o,t){t.sort_request.update===!1&&BabblingBrook.Client.Component.StreamSideBar.onSorted(t.sort_request.filter.url,f),t.sort_request.client_uid===b&&(t.sort_request.filter.url===BabblingBrook.Library.makeRhythmUrl(s,"json")&&(t.sort_request.update===!1?(o(t.posts),g(t.sort_request)):r.update(t.posts),e.removeClass("block-loading")),BabblingBrook.Client.Page.Stream.Stream.onStreamLoadedHook(i))},k=function(e){var r=BabblingBrook.Library.changeUrlAction(e,""),o=jQuery("#stream_not_found_template>div").clone();jQuery(".stream-location",o).text(r),jQuery("#content_page").empty().append(o)},p=function(e,r){var o=r.error_code;if("404"===o)return void k(e);var t="An unknown error has occoured whilst fetching stream data for : "+e;switch(o){case"404":t="stream not found: "+e;break;case"SortRequest_filter":t="A filter has not been found for : "+e}BabblingBrook.Client.Component.Messages.addMessage({type:"error",message:t})},h=function(){jQuery(".make-post").addClass("hide"),P()},C=function(e){"photowall"===o?r.insertPost(e):(e.stream_name=BabblingBrook.Library.normaliseResourceName(e.stream_name),i.name=BabblingBrook.Library.normaliseResourceName(i.name),e.stream_domain===i.domain&&e.stream_username===i.username&&e.stream_name===i.name&&r.update([e],!0));var t=new BabblingBrook.Client.Component.MakePost(C,h);jQuery(".make-post").html("");var a=BabblingBrook.Library.changeUrlAction(n,"json");t.setupNewPost(a,jQuery(".make-post"),"minimised")},v=function(e){var r=BabblingBrook.Library.changeUrlAction(n,"rhythm"),o=BabblingBrook.Library.extractDomain(e),t=BabblingBrook.Library.extractUsername(e),a=BabblingBrook.Library.extractName(e),i=BabblingBrook.Library.extractVersion(e);r=r+"/"+o+"/"+t+"/"+a+"/"+i,BabblingBrook.Client.Core.Ajaxurl.changeUrl(r,"BabblingBrook.Client.Page.Stream.Stream.construct")},_=function(){switch(o){case"photowall":L();break;case"list":S();break;default:throw"Invalid stream presentation type :"+o}},S=function(){r=new BabblingBrook.Client.Component.Cascade(e,m,q.bind(null,!0,void 0),void 0,void 0,B)},L=function(){r=new BabblingBrook.Client.Component.Photowall(e,d,q.bind(null,!0,void 0))},j=function(e){s=e;var r=BabblingBrook.Library.makeRhythmUrl(e);v(r),_()},w=function(){"undefined"==typeof i&&(i=BabblingBrook.Library.makeStreamFromUrl(window.location.href,!0)),n=BabblingBrook.Library.makeStreamUrl(i,"")},Q=function(){switch(o){case"photowall":jQuery("#sidebar").addClass("sidebar-top").removeClass("sidebar-side"),jQuery("#sidebar_extra").addClass("sidebar-hide"),jQuery("#sidebar_open").removeClass("hide");break;case"list":jQuery("#sidebar").addClass("sidebar-side").removeClass("sidebar-top"),jQuery("#sidebar_extra").removeClass("sidebar-hide"),jQuery("#sidebar_open").addClass("hide");break;default:throw"Invalid stream presentation type :"+o}BabblingBrook.Client.Component.Resize.retest()},U=function(){var e=BabblingBrook.Library.changeUrlAction(n,"json");BabblingBrook.Client.Core.Streams.getStream(i.domain,i.username,i.name,BabblingBrook.Library.makeVersionString(i.version),function(e){e.default_rhythms.length<1&&(e.default_rhythms=BabblingBrook.Client.ClientConfig.default_sort_filters),o=e.presentation_type,Q(),t=e.default_rhythms;for(var r in t){var a=t[r].version;if("object"==typeof a){var n=a.major+"/"+a.minor+"/"+a.patch;t[r].version=n,t[r].priority=t[r].sort_order}}BabblingBrook.Client.Component.StreamSideBar.onStreamChanged(e),I(),BabblingBrook.Client.Component.StreamSideBar.onFiltersLoaded(t,j,f),_(),M()},p.bind(null,e))},P=function(){if(BabblingBrook.Settings.feature_switches.MAKE_SELF_POST!==!1){var e=BabblingBrook.Library.changeUrlAction(n,"json"),r=new BabblingBrook.Client.Component.MakePost(C,h),o=jQuery(".make-post");o.slideDown(250,function(){o.removeClass("hide")}),r.setupNewPost(e,jQuery(".make-post"),"minimised")}},x=function(){if(c(),"object"==typeof l){s=l;var e=BabblingBrook.Library.makeRhythmUrl(s,"");s.params=[];var r=!1;jQuery.each(t,function(o,t){var a=BabblingBrook.Library.makeRhythmUrl(t,"");a===e&&(t.priority=1,r=!0)}),r===!1&&t.unshift(l)}else s=t[0]},I=function(){var e={},r=BabblingBrook.Client.Core.StreamSubscriptions.getStreamSubscriptionIDFromStream(i);if("undefined"!=typeof r){var o=BabblingBrook.Client.Core.StreamSubscriptions.getStreamSubscriptionFromId(r),a=Object.keys(o.filters).length;a>0&&(jQuery.extend(!0,e,o.filters),t=[])}var n=10;jQuery.each(e,function(r){e[r].priority=n,n++,t.push(e[r])}),x()},A=function(){a=BabblingBrook.Client.Component.StreamNav.getModerationRings(n)},R=function(e,r,o){var t=BabblingBrook.Library.makeStreamUrl(e,"",!0)+"|"+BabblingBrook.Library.makeRhythmUrl(r,"",!0)+"|";jQuery.each(o,function(e,r){t+=r.domain+"/"+r.username+"|"});var a=BabblingBrook.Library.generateHashCode(t);return a},q=function(e,r,o,t){"undefined"==typeof t&&(t=s);var l={url:BabblingBrook.Library.makeRhythmUrl(t,"json"),priority:t.priority,name:t.name},m=R(i,t,a);e===!0&&(b=m);var d=BabblingBrook.Library.changeUrlAction(n,"json");BabblingBrook.Client.Component.StreamSideBar.onFilterLoading(t,void 0,f),BabblingBrook.Client.Core.Interact.postAMessage({sort_request:{type:"stream",client_uid:m,streams:[i],filter:l,moderation_rings:a,posts_to_timestamp:null,client_params:r}},"SortRequest",y.bind(null,o),p.bind(null,d),BabblingBrook.Client.User.Config.action_timeout)},M=function(){for(var e=2,r=0;e>r;r++){if("undefined"==typeof t[r])return;q(!1,void 0,function(){},t[r])}};return{construct:function(e){BabblingBrook.Client.Core.Loaded.onStreamSubscriptionsLoaded(function(){u(),"undefined"!=typeof e&&(i=e),w(),P(),A(),U()})},onStreamLoadedHook:function(){}}}(),jQuery(function(){"use strict";BabblingBrook.Client.Core.Loaded.onUserLoaded(function(){"true"===jQuery("#on_stream_page").val()&&BabblingBrook.Client.Page.Stream.Stream.construct()})});
//# sourceMappingURL=/js/Minified/Client/Page/Stream/Stream.js.map