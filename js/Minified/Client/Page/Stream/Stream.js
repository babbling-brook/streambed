"object"!=typeof BabblingBrook.Client.Page.Stream&&(BabblingBrook.Client.Page.Stream={}),BabblingBrook.Client.Page.Stream.Stream=function(){"use strict";var r,e,o,t,n,a,i,s,l="#post_stream_template>.post",b=function(){r=jQuery("#stream_container"),r.empty(),n=void 0,i=void 0,o=void 0,s=void 0,a=void 0},m=function(){var r=BabblingBrook.Library.extractAction(window.location.href);if("rhythm"===r){var e=window.location.href;s={domain:BabblingBrook.Library.extractPathItem(e,8),username:BabblingBrook.Library.extractPathItem(e,9),name:BabblingBrook.Library.decodeUrlComponent(BabblingBrook.Library.extractPathItem(e,10)),version:BabblingBrook.Library.extractPathItem(e,11)+"/"+BabblingBrook.Library.extractPathItem(e,12)+"/"+BabblingBrook.Library.extractPathItem(e,13)}}},u=function(r,e){if("undefined"==typeof e.sort||""===e.sort)return void jQuery("div>span.sort-score-intro",r).addClass("hide");var o=jQuery("div>span.sort-score-intro>span.sort-score",r);o.text(e.sort),parseInt(e.sort)<-2&&r.addClass("low-sort"),parseInt(e.sort)>1e9&&r.addClass("high-sort")},B=function(r){var e=BabblingBrook.Library.changeUrlAction(r.stream_url,"json"),o={stream_url:e,post_id:null,type:r.type,filter:r.filter,moderation_rings:r.moderation_rings,priority:r.priority,refresh_frequency:r.refresh_frequency,block_numbers:r.block_numbers,success:d.bind(null,void 0),error:f.bind(null,e)};BabblingBrook.Client.Core.FetchMore.register(o)},c=function(o){r.empty(),e=new BabblingBrook.Client.Component.Cascade(r,l,U.bind(null,o),void 0,void 0,u)},d=function(o,t){t.sort_request.stream_url=BabblingBrook.Library.changeUrlAction(t.sort_request.stream_url,""),n===t.sort_request.stream_url&&(t.sort_request.update===!1&&BabblingBrook.Client.Component.StreamSideBar.onSorted(t.sort_request.filter.url,c),t.sort_request.filter.url===BabblingBrook.Library.makeRhythmUrl(i,"json")&&(t.sort_request.update===!1?(o(t.posts),B(t.sort_request)):e.update(t.posts),r.removeClass("block-loading")),BabblingBrook.Client.Page.Stream.Stream.onStreamLoadedHook(a))},g=function(r){var e=BabblingBrook.Library.changeUrlAction(r,""),o=jQuery("#stream_not_found_template>div").clone();jQuery(".stream-location",o).text(e),jQuery("#content_page").empty().append(o)},f=function(r,e){var o=e.error_code;if("404"===o)return void g(r);var t="An unknown error has occoured whilst fetching stream data for : "+r;switch(o){case"404":t="stream not found: "+r;break;case"SortRequest_filter":t="A filter has not been found for : "+r}BabblingBrook.Client.Component.Messages.addMessage({type:"error",message:t})},y=function(){jQuery(".make-post").addClass("hide"),_()},k=function(r){if(r.stream_name=BabblingBrook.Library.normaliseResourceName(r.stream_name),a.name=BabblingBrook.Library.normaliseResourceName(a.name),r.stream_domain===a.domain&&r.stream_username===a.username&&r.stream_name===a.name){e.update([r],!0);var o=new BabblingBrook.Client.Component.MakePost(k,y);jQuery(".make-post").html("");var t=BabblingBrook.Library.changeUrlAction(n,"json");o.setupNewPost(t,jQuery(".make-post"),"minimised")}},p=function(r){var e=BabblingBrook.Library.changeUrlAction(n,"rhythm"),o=BabblingBrook.Library.extractDomain(r),t=BabblingBrook.Library.extractUsername(r),a=BabblingBrook.Library.extractName(r),i=BabblingBrook.Library.extractVersion(r);e=e+"/"+o+"/"+t+"/"+a+"/"+i,BabblingBrook.Client.Core.Ajaxurl.changeUrl(e,"BabblingBrook.Client.Page.Stream.Stream.construct")},h=function(o){i=o;var t=BabblingBrook.Library.makeRhythmUrl(o);p(t),e=new BabblingBrook.Client.Component.Cascade(r,l,U.bind(null,void 0),void 0,void 0,u)},C=function(){"undefined"==typeof a&&(a=BabblingBrook.Library.makeStreamFromUrl(window.location.href,!0)),n=BabblingBrook.Library.makeStreamUrl(a,"")},v=function(){var t=BabblingBrook.Library.changeUrlAction(n,"json");BabblingBrook.Client.Core.Streams.getStream(a.domain,a.username,a.name,BabblingBrook.Library.makeVersionString(a.version),function(t){t.default_rhythms.length<1&&(t.default_rhythms=BabblingBrook.Client.ClientConfig.default_sort_filters),o=t.default_rhythms;for(var n in o){var a=o[n].version;if("object"==typeof a){var i=a.major+"/"+a.minor+"/"+a.patch;o[n].version=i,o[n].priority=o[n].sort_order}}BabblingBrook.Client.Component.StreamSideBar.onStreamChanged(t),L(),BabblingBrook.Client.Component.StreamSideBar.onFiltersLoaded(o,h,c),e=new BabblingBrook.Client.Component.Cascade(r,l,U.bind(null,void 0),void 0,void 0,u),w()},f.bind(null,t))},_=function(){if(BabblingBrook.Settings.feature_switches.MAKE_SELF_POST!==!1){var r=BabblingBrook.Library.changeUrlAction(n,"json"),e=new BabblingBrook.Client.Component.MakePost(k,y),o=jQuery(".make-post");o.slideDown(250,function(){o.removeClass("hide")}),e.setupNewPost(r,jQuery(".make-post"),"minimised")}},S=function(){if(m(),"object"==typeof s){i=s;var r=BabblingBrook.Library.makeRhythmUrl(i,"");i.params=[];var e=!1;jQuery.each(o,function(o,t){var n=BabblingBrook.Library.makeRhythmUrl(t,"");n===r&&(t.priority=1,e=!0)}),e===!1&&o.unshift(s)}else i=o[0]},L=function(){var r={},e=BabblingBrook.Client.Core.StreamSubscriptions.getStreamSubscriptionIDFromStream(a);if("undefined"!=typeof e){var t=BabblingBrook.Client.Core.StreamSubscriptions.getStreamSubscriptionFromId(e),n=Object.keys(t.filters).length;n>0&&(jQuery.extend(!0,r,t.filters),o=[])}var i=10;jQuery.each(r,function(e){r[e].priority=i,i++,o.push(r[e])}),S()},j=function(){t=BabblingBrook.Client.Component.StreamNav.getModerationRings(n)},U=function(r,e,o){"undefined"==typeof o&&(o=i);var a={url:BabblingBrook.Library.makeRhythmUrl(o,"json"),priority:o.priority,name:o.name},s=BabblingBrook.Library.changeUrlAction(n,"json");BabblingBrook.Client.Component.StreamSideBar.onFilterLoading(o,void 0,c),BabblingBrook.Client.Core.Interact.postAMessage({sort_request:{type:"stream",stream_url:s,filter:a,moderation_rings:t,posts_to_timestamp:null,client_params:r}},"SortRequest",d.bind(null,e),f.bind(null,s),BabblingBrook.Client.User.Config.action_timeout)},w=function(){for(var r=2,e=0;r>e;e++){if("undefined"==typeof o[e])return;U(void 0,function(){},o[e])}};return{construct:function(r){BabblingBrook.Client.Core.Loaded.onStreamSubscriptionsLoaded(function(){b(),"undefined"!=typeof r&&(a=r),C(),_(),j(),v()})},onStreamLoadedHook:function(){}}}(),jQuery(function(){"use strict";BabblingBrook.Client.Core.Loaded.onUserLoaded(function(){"true"===jQuery("#on_stream_page").val()&&BabblingBrook.Client.Page.Stream.Stream.construct()})});
//# sourceMappingURL=/js/Minified/Client/Page/Stream/Stream.js.map